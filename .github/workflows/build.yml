name: Build libusb Android (arm64-v8a)

on:
  workflow_dispatch:
  push:
    branches: [ main ]
  pull_request:

jobs:
  build-android-arm64:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout libusb source
        uses: actions/checkout@v4
        with:
          repository: itachicoders/libusb
          path: libusb

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y autoconf automake libtool pkg-config wget unzip

      - name: Download Android NDK
        run: |
          wget https://dl.google.com/android/repository/android-ndk-r26d-linux.zip
          unzip -q android-ndk-r26d-linux.zip
          mv android-ndk-r26d $HOME/android-ndk
          echo "NDK=$HOME/android-ndk" >> $GITHUB_ENV

      - name: Set environment for arm64-v8a
        run: |
          export TOOLCHAIN=$NDK/toolchains/llvm/prebuilt/linux-x86_64
          export TARGET=aarch64-linux-android
          export API=21
          export AR=$TOOLCHAIN/bin/llvm-ar
          export AS=$TOOLCHAIN/bin/$TARGET$API-as
          export CC=$TOOLCHAIN/bin/$TARGET$API-clang
          export CXX=$TOOLCHAIN/bin/$TARGET$API-clang++
          export LD=$TOOLCHAIN/bin/ld
          export RANLIB=$TOOLCHAIN/bin/llvm-ranlib
          export STRIP=$TOOLCHAIN/bin/llvm-strip
          export PATH=$TOOLCHAIN/bin:$PATH

          cd libusb
          ./autogen.sh
          mkdir -p build && cd build
          ../configure \
            --host=$TARGET \
            --enable-static \
            --disable-shared \
            --disable-udev \
            CFLAGS="-fPIC" \
            LDFLAGS="-static"
          make -j$(nproc)

      - name: Upload libusb.a
        uses: actions/upload-artifact@v4
        with:
          name: libusb-arm64-v8a
          path: libusb/build/libusb/.libs/libusb-1.0.a
